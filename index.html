<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appuesta LATAM - Financial Forecast Model v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #53565a; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #e4002b 0%, #b8001f 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border: 2px solid #e0e6ed; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab:hover { border-color: #e4002b; color: #e4002b; }
        .tab.active { background: #e4002b; color: white; border-color: #e4002b; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .scenario-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .scenario-btn { flex: 1; padding: 15px; background: white; border: 2px solid #e0e6ed; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .scenario-btn.active { background: #e4002b; color: white; border-color: #e4002b; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric-card h3 { font-size: 14px; color: #7f8c8d; margin-bottom: 10px; text-transform: uppercase; }
        .metric-card .value { font-size: 28px; font-weight: 700; color: #53565a; margin-bottom: 5px; }
        .metric-card.positive .value { color: #27ae60; }
        .metric-card.negative .value { color: #e4002b; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h2 { font-size: 20px; margin-bottom: 20px; border-bottom: 2px solid #e4002b; padding-bottom: 10px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .input-group input { padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px; }
        .input-group input:focus { outline: none; border-color: #e4002b; }
        .input-group small { color: #7f8c8d; margin-top: 5px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        table th { background: #f8f9fa; padding: 10px 6px; text-align: right; font-weight: 600; border-bottom: 2px solid #e0e6ed; color: #53565a; }
        table th:first-child { text-align: left; }
        table td { padding: 8px 6px; text-align: right; border-bottom: 1px solid #f0f0f0; }
        table td:first-child { text-align: left; font-weight: 500; }
        .section-header td { background: #e4002b; color: white !important; font-weight: 700; }
        .subsection-header td { background: #f8f9fa; font-weight: 600; color: #53565a; }
        .total-row td { background: #fff3f5; font-weight: 700; border-top: 2px solid #e4002b; }
        .subtotal-row td { background: #fafafa; font-weight: 600; }
        .indent { padding-left: 20px !important; }
        .chart-container { position: relative; height: 400px; margin-top: 20px; }
        .btn { padding: 12px 24px; background: #e4002b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.3s; }
        .btn:hover { background: #b8001f; }
        .milestone { padding: 15px; background: linear-gradient(135deg, #e4002b15 0%, #b8001f15 100%); border-left: 4px solid #e4002b; border-radius: 6px; margin-bottom: 15px; }
        .table-wrapper { overflow-x: auto; max-height: 800px; overflow-y: auto; }
        .negative-value { color: #e4002b; }
        .positive-value { color: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé∞ Appuesta LATAM - Financial Forecast</h1>
            <p>November 2025 - December 2026 | Version 2</p>
        </div>
        
        <div class="scenario-toggle">
            <button class="scenario-btn active" onclick="switchScenario('base')">üìä Base Case</button>
            <button class="scenario-btn" onclick="switchScenario('aggressive')">üöÄ Aggressive</button>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('assumptions')">Assumptions</div>
            <div class="tab" onclick="switchTab('pl')">P&L</div>
            <div class="tab" onclick="switchTab('charts')">Charts</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Total Users (Dec 2026)</h3>
                    <div class="value" id="totalUsers">-</div>
                </div>
                <div class="metric-card">
                    <h3>Monthly Revenue (Dec 2026)</h3>
                    <div class="value" id="monthlyRevenue">-</div>
                </div>
                <div class="metric-card">
                    <h3>Annual Revenue (2026)</h3>
                    <div class="value" id="annualRevenue">-</div>
                </div>
                <div class="metric-card" id="ebitdaCard">
                    <h3>EBITDA (Dec 2026)</h3>
                    <div class="value" id="ebitda">-</div>
                </div>
                <div class="metric-card">
                    <h3>LTV : CAC</h3>
                    <div class="value" id="ltvCac">-</div>
                </div>
                <div class="metric-card">
                    <h3>Break-Even</h3>
                    <div class="value" id="breakEven">-</div>
                </div>
                <div class="metric-card" id="runwayCard">
                    <h3>Runway</h3>
                    <div class="value" id="runway">-</div>
                </div>
                <div class="metric-card" id="cashOutCard">
                    <h3>Cash-Out Date</h3>
                    <div class="value" id="cashOutDate">-</div>
                </div>
                <div class="metric-card" id="endingCashCard">
                    <h3>Ending Cash (Dec 2026)</h3>
                    <div class="value" id="endingCash">-</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Cash Runway</h2>
                <div id="runwayBar" style="margin-bottom: 20px;"></div>
                <div class="chart-container">
                    <canvas id="cashChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>Key Milestones</h2>
                <div id="milestones"></div>
            </div>
            
            <div class="card">
                <h2>Growth Trajectory</h2>
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="assumptions" class="tab-content">
            <div class="card">
                <h2>Revenue & Users</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Starting Users</label>
                        <input type="number" id="startUsers" value="164">
                    </div>
                    <div class="input-group">
                        <label>Starting MRPU ($)</label>
                        <input type="number" id="startMRPU" value="51.16" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>MRPU Growth (%/mo)</label>
                        <input type="number" id="mrpuGrowth" value="3" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>MRPU Cap ($)</label>
                        <input type="number" id="mrpuCap" value="120">
                    </div>
                    <div class="input-group">
                        <label>Retention (%)</label>
                        <input type="number" id="retention" value="60">
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Marketing & CAC</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Starting Marketing Budget ($)</label>
                        <input type="number" id="mktBudget" value="3000">
                    </div>
                    <div class="input-group">
                        <label>Marketing Growth (%/mo)</label>
                        <input type="number" id="mktGrowth" value="0" step="1">
                        <small>Monthly increase in marketing spend</small>
                    </div>
                    <div class="input-group">
                        <label>Marketing Budget Cap ($)</label>
                        <input type="number" id="mktCap" value="50000">
                        <small>Maximum monthly marketing spend</small>
                    </div>
                    <div class="input-group">
                        <label>Starting CAC ($)</label>
                        <input type="number" id="startCAC" value="37.32" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>CAC Improvement (%/mo)</label>
                        <input type="number" id="cacImp" value="0" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>CAC Floor ($)</label>
                        <input type="number" id="cacFloor" value="35">
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Funding & Runway</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Starting Cash Balance ($)</label>
                        <input type="number" id="startingCash" value="80000">
                        <small>Current cash on hand</small>
                    </div>
                    <div class="input-group">
                        <label>Minimum Cash Buffer ($)</label>
                        <input type="number" id="cashBuffer" value="10000">
                        <small>Safety threshold before warnings trigger</small>
                    </div>
                    <div class="input-group">
                        <label>Expected Funding Amount ($)</label>
                        <input type="number" id="fundingAmount" value="0">
                        <small>Leave 0 if no raise planned</small>
                    </div>
                    <div class="input-group">
                        <label>Expected Funding Month</label>
                        <select id="fundingMonth">
                            <option value="-1">No funding planned</option>
                            <option value="0">Nov-25</option>
                            <option value="1">Dec-25</option>
                            <option value="2">Jan-26</option>
                            <option value="3">Feb-26</option>
                            <option value="4">Mar-26</option>
                            <option value="5">Apr-26</option>
                            <option value="6">May-26</option>
                            <option value="7">Jun-26</option>
                            <option value="8">Jul-26</option>
                            <option value="9">Aug-26</option>
                            <option value="10">Sep-26</option>
                            <option value="11">Oct-26</option>
                            <option value="12">Nov-26</option>
                            <option value="13">Dec-26</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Bonus & Promotions</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Bonus Cost (% of GGR)</label>
                        <input type="number" id="bonusCost" value="20" step="0.5">
                        <small>Player bonuses, free bets, promotions</small>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Fixed Costs (Monthly $)</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Payroll</label>
                        <input type="number" id="payroll" value="5300">
                    </div>
                    <div class="input-group">
                        <label>G&A</label>
                        <input type="number" id="gna" value="1500">
                    </div>
                    <div class="input-group">
                        <label>Tech Services</label>
                        <input type="number" id="tech" value="620">
                    </div>
                    <div class="input-group">
                        <label>KYC</label>
                        <input type="number" id="kyc" value="150">
                    </div>
                    <div class="input-group">
                        <label>Affiliate Platform (‚Ç¨)</label>
                        <input type="number" id="affPlat" value="2800">
                    </div>
                    <div class="input-group">
                        <label>Affiliate Employee (‚Ç¨)</label>
                        <input type="number" id="affEmp" value="1800">
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>CS Center (Jan 2026)</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>CS Payroll ($)</label>
                        <input type="number" id="csPayroll" value="2500">
                    </div>
                    <div class="input-group">
                        <label>CS Tax (%)</label>
                        <input type="number" id="csTax" value="30">
                    </div>
                    <div class="input-group">
                        <label>CS Tools ($)</label>
                        <input type="number" id="csTools" value="200">
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Variable Costs</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Payment Fee (%)</label>
                        <input type="number" id="payFee" value="2.4" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Deposit/GGR Ratio</label>
                        <input type="number" id="depRatio" value="3" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>Betby Fee (%)</label>
                        <input type="number" id="betbyFee" value="13">
                    </div>
                    <div class="input-group">
                        <label>Casino Fee (%)</label>
                        <input type="number" id="casinoFee" value="10">
                    </div>
                    <div class="input-group">
                        <label>Sportsbook Split (%)</label>
                        <input type="number" id="sbSplit" value="50">
                    </div>
                    <div class="input-group">
                        <label>EUR/USD</label>
                        <input type="number" id="eurUsd" value="1.05" step="0.01">
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="calc()" style="margin: 20px 0;">üíæ Save & Recalculate</button>
        </div>
        
        <div id="pl" class="tab-content">
            <div class="card">
                <h2>Profit & Loss Statement (Detailed)</h2>
                <div class="table-wrapper">
                    <table id="plTable"></table>
                </div>
            </div>
        </div>
        
        <div id="charts" class="tab-content">
            <div class="card">
                <h2>Revenue & Users</h2>
                <div class="chart-container">
                    <canvas id="revChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>EBITDA & Cash Flow</h2>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>User Growth</h2>
                <div class="chart-container">
                    <canvas id="userChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scenario = 'base';
        let data = {};
        let charts = {};
        let detailedData = {};

        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(t).classList.add('active');
            if (t === 'charts') {
                setTimeout(renderCharts, 100);
            }
        }

        function switchScenario(s) {
            scenario = s;
            document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (s === 'base') {
                document.getElementById('retention').value = 60;
                document.getElementById('cacImp').value = 0;
                document.getElementById('mrpuGrowth').value = 3;
                document.getElementById('cacFloor').value = 35;
                document.getElementById('bonusCost').value = 20;
            } else {
                document.getElementById('retention').value = 70;
                document.getElementById('cacImp').value = 5;
                document.getElementById('mrpuGrowth').value = 5;
                document.getElementById('cacFloor').value = 30;
                document.getElementById('bonusCost').value = 18;
            }
            calc();
        }

        function getVal(id) {
            return parseFloat(document.getElementById(id).value) || 0;
        }

        function calc() {
            const p = {
                users: getVal('startUsers'),
                mrpu: getVal('startMRPU'),
                mrpuGr: getVal('mrpuGrowth') / 100,
                mrpuCap: getVal('mrpuCap'),
                ret: getVal('retention') / 100,
                mkt: getVal('mktBudget'),
                mktGrowth: getVal('mktGrowth') / 100,
                mktCap: getVal('mktCap'),
                cac: getVal('startCAC'),
                cacImp: getVal('cacImp') / 100,
                cacFloor: getVal('cacFloor'),
                startingCash: getVal('startingCash'),
                cashBuffer: getVal('cashBuffer'),
                fundingAmount: getVal('fundingAmount'),
                fundingMonth: parseInt(document.getElementById('fundingMonth').value),
                bonusCost: getVal('bonusCost') / 100,
                payroll: getVal('payroll'),
                gna: getVal('gna'),
                tech: getVal('tech'),
                kyc: getVal('kyc'),
                affPlat: getVal('affPlat') * getVal('eurUsd'),
                affEmp: getVal('affEmp') * getVal('eurUsd'),
                csPayroll: getVal('csPayroll'),
                csTax: getVal('csTax') / 100,
                csTools: getVal('csTools'),
                payFee: getVal('payFee') / 100,
                depRatio: getVal('depRatio'),
                betbyFee: getVal('betbyFee') / 100,
                casinoFee: getVal('casinoFee') / 100,
                sbSplit: getVal('sbSplit') / 100,
                eurUsd: getVal('eurUsd')
            };

            const months = ['Nov-25', 'Dec-25', 'Jan-26', 'Feb-26', 'Mar-26', 'Apr-26', 'May-26', 'Jun-26', 'Jul-26', 'Aug-26', 'Sep-26', 'Oct-26', 'Nov-26', 'Dec-26'];
            
            data = {
                months: [],
                users: [],
                ggr: [],
                netRev: [],
                ebitda: [],
                cashFlow: 0,
                newUsers: [],
                cacs: []
            };

            detailedData = {
                retainedUsers: [],
                newUsers: [],
                mrpu: [],
                sbGGR: [],
                casinoGGR: [],
                bonusCosts: [],
                betbyFee: [],
                casinoProvFee: [],
                flexsyFee: [],
                gamingtecFee: [],
                totalProvFees: [],
                deposits: [],
                txnVol: [],
                paymentFee: [],
                grossProfit: [],
                payroll: [],
                gna: [],
                tech: [],
                kyc: [],
                affPlat: [],
                affEmp: [],
                csTotal: [],
                marketing: [],
                totalFixedCosts: [],
                oneTimeCosts: [],
                cumCash: [],
                cac: [],
                cashBalance: [],
                fundingInflow: []
            };

            let cumGGR = 0;
            let currentMRPU = p.mrpu;
            let currentCAC = p.cac;
            let currentMkt = p.mkt;
            let cumCash = 0;
            let cashBalance = p.startingCash;

            for (let i = 0; i < 14; i++) {
                const m = months[i];
                const isDec = i === 1;

                // MRPU growth with cap
                if (i > 0 && currentMRPU < p.mrpuCap) {
                    currentMRPU = Math.min(currentMRPU * (1 + p.mrpuGr), p.mrpuCap);
                }

                // CAC improvement
                if (i > 0) {
                    currentCAC = Math.max(currentCAC * (1 - p.cacImp), p.cacFloor);
                }

                // Marketing budget growth
                if (i > 0) {
                    currentMkt = Math.min(currentMkt * (1 + p.mktGrowth), p.mktCap);
                }

                // User calculations
                const retainedUsers = i === 0 ? p.users : Math.floor(data.users[i - 1] * p.ret);
                const newUsers = Math.floor(currentMkt / currentCAC);
                const totalUsers = retainedUsers + newUsers;

                // Revenue calculations
                const ggr = totalUsers * currentMRPU;
                cumGGR += ggr;

                const sbGGR = ggr * p.sbSplit;
                const casinoGGR = ggr * (1 - p.sbSplit);

                // Bonus costs
                const bonusCosts = ggr * p.bonusCost;

                // Provider fees
                const betbyFee = sbGGR * p.betbyFee;
                const casinoProvFee = casinoGGR * p.casinoFee;

                // Flexsy fee with minimums
                const flexsyRate = cumGGR < 500000 ? 0.04 : 0.03;
                let flexsyFee = ggr * flexsyRate;
                if (i >= 3 && i <= 5) flexsyFee = Math.max(flexsyFee, 2000 * p.eurUsd);
                if (i >= 6 && i <= 8) flexsyFee = Math.max(flexsyFee, 4000 * p.eurUsd);
                if (i >= 9 && i <= 11) flexsyFee = Math.max(flexsyFee, 6000 * p.eurUsd);
                if (i >= 12) flexsyFee = Math.max(flexsyFee, 12000 * p.eurUsd);

                const gamingtecFee = isDec ? 2000 : 0;
                const totalProvFees = betbyFee + casinoProvFee + flexsyFee + gamingtecFee;

                // Payment processing
                const deposits = ggr * p.depRatio;
                const txnVol = deposits * 2;
                const paymentFee = txnVol * p.payFee;

                // Gross profit (after variable costs)
                const grossProfit = ggr - bonusCosts - totalProvFees - paymentFee;

                // Fixed costs
                const payroll = p.payroll;
                const gna = p.gna;
                const tech = p.tech;
                const kyc = p.kyc;
                const affPlat = p.affPlat;
                const affEmp = p.affEmp;
                const csTotal = i >= 2 ? p.csPayroll * (1 + p.csTax) + p.csTools : 0;
                const marketing = currentMkt;

                const totalFixedCosts = payroll + gna + tech + kyc + affPlat + affEmp + csTotal + marketing;

                // One-time costs
                const oneTimeCosts = isDec ? 12589.31 : 0;

                // Net revenue and EBITDA
                const netRev = grossProfit;
                const ebitda = grossProfit - totalFixedCosts - oneTimeCosts;

                cumCash += ebitda;

                // Cash balance with funding
                const fundingInflow = (p.fundingMonth === i) ? p.fundingAmount : 0;
                cashBalance += ebitda + fundingInflow;

                // Store main data
                data.months.push(m);
                data.users.push(totalUsers);
                data.ggr.push(ggr);
                data.netRev.push(netRev);
                data.ebitda.push(ebitda);
                data.newUsers.push(newUsers);
                data.cacs.push(currentCAC);

                // Store detailed data
                detailedData.retainedUsers.push(retainedUsers);
                detailedData.newUsers.push(newUsers);
                detailedData.mrpu.push(currentMRPU);
                detailedData.sbGGR.push(sbGGR);
                detailedData.casinoGGR.push(casinoGGR);
                detailedData.bonusCosts.push(bonusCosts);
                detailedData.betbyFee.push(betbyFee);
                detailedData.casinoProvFee.push(casinoProvFee);
                detailedData.flexsyFee.push(flexsyFee);
                detailedData.gamingtecFee.push(gamingtecFee);
                detailedData.totalProvFees.push(totalProvFees);
                detailedData.deposits.push(deposits);
                detailedData.txnVol.push(txnVol);
                detailedData.paymentFee.push(paymentFee);
                detailedData.grossProfit.push(grossProfit);
                detailedData.payroll.push(payroll);
                detailedData.gna.push(gna);
                detailedData.tech.push(tech);
                detailedData.kyc.push(kyc);
                detailedData.affPlat.push(affPlat);
                detailedData.affEmp.push(affEmp);
                detailedData.csTotal.push(csTotal);
                detailedData.marketing.push(marketing);
                detailedData.totalFixedCosts.push(totalFixedCosts);
                detailedData.oneTimeCosts.push(oneTimeCosts);
                detailedData.cumCash.push(cumCash);
                detailedData.cac.push(currentCAC);
                detailedData.cashBalance.push(cashBalance);
                detailedData.fundingInflow.push(fundingInflow);
            }

            // Store funding params for dashboard
            data.startingCash = p.startingCash;
            data.cashBuffer = p.cashBuffer;
            data.fundingAmount = p.fundingAmount;
            data.fundingMonth = p.fundingMonth;

            data.cashFlow = cumCash;
            updateDashboard();
            updatePL();
        }

        function updateDashboard() {
            const last = data.months.length - 1;
            
            document.getElementById('totalUsers').textContent = data.users[last].toLocaleString();
            document.getElementById('monthlyRevenue').textContent = '$' + data.netRev[last].toLocaleString(undefined, { maximumFractionDigits: 0 });
            
            const annualRev = data.netRev.slice(2).reduce((a, b) => a + b, 0);
            document.getElementById('annualRevenue').textContent = '$' + annualRev.toLocaleString(undefined, { maximumFractionDigits: 0 });
            
            const ebitda = data.ebitda[last];
            document.getElementById('ebitda').textContent = '$' + ebitda.toLocaleString(undefined, { maximumFractionDigits: 0 });
            
            const ebitdaCard = document.getElementById('ebitdaCard');
            ebitdaCard.className = 'metric-card ' + (ebitda > 0 ? 'positive' : 'negative');

            // LTV:CAC calculation
            const avgMRPU = data.netRev[last] / data.users[last];
            const avgCAC = data.cacs[last];
            const ret = getVal('retention') / 100;
            const ltv = avgMRPU / (1 - ret);
            const ltvCac = ltv / avgCAC;
            document.getElementById('ltvCac').textContent = ltvCac.toFixed(2);

            // Break-even calculation
            let breakEven = 'Not reached';
            for (let i = 0; i < detailedData.cumCash.length; i++) {
                if (detailedData.cumCash[i] > 0) {
                    breakEven = data.months[i];
                    break;
                }
            }
            document.getElementById('breakEven').textContent = breakEven;

            // Runway calculations
            let runway = 0;
            let cashOutDate = 'N/A';
            let cashOutIndex = -1;
            
            for (let i = 0; i < detailedData.cashBalance.length; i++) {
                if (detailedData.cashBalance[i] > data.cashBuffer) {
                    runway++;
                } else {
                    if (cashOutIndex === -1) {
                        cashOutIndex = i;
                        cashOutDate = data.months[i];
                    }
                }
            }
            
            // If we never run out, runway is full period
            if (cashOutIndex === -1 && detailedData.cashBalance[detailedData.cashBalance.length - 1] > data.cashBuffer) {
                cashOutDate = 'Beyond Dec-26';
            }
            
            document.getElementById('runway').textContent = runway + ' months';
            document.getElementById('cashOutDate').textContent = cashOutDate;
            
            // Ending cash
            const endingCash = detailedData.cashBalance[detailedData.cashBalance.length - 1];
            document.getElementById('endingCash').textContent = '$' + endingCash.toLocaleString(undefined, { maximumFractionDigits: 0 });
            
            // Color code runway card
            const runwayCard = document.getElementById('runwayCard');
            if (runway >= 9) {
                runwayCard.className = 'metric-card positive';
            } else if (runway >= 6) {
                runwayCard.className = 'metric-card';
            } else {
                runwayCard.className = 'metric-card negative';
            }
            
            // Color code cash-out card
            const cashOutCard = document.getElementById('cashOutCard');
            if (cashOutDate === 'Beyond Dec-26') {
                cashOutCard.className = 'metric-card positive';
            } else if (runway >= 6) {
                cashOutCard.className = 'metric-card';
            } else {
                cashOutCard.className = 'metric-card negative';
            }
            
            // Color code ending cash card
            const endingCashCard = document.getElementById('endingCashCard');
            if (endingCash > data.cashBuffer) {
                endingCashCard.className = 'metric-card positive';
            } else if (endingCash > 0) {
                endingCashCard.className = 'metric-card';
            } else {
                endingCashCard.className = 'metric-card negative';
            }
            
            // Runway progress bar
            const runwayPercent = Math.min((runway / 14) * 100, 100);
            let barColor = '#27ae60';
            if (runway < 6) barColor = '#e4002b';
            else if (runway < 9) barColor = '#f39c12';
            
            document.getElementById('runwayBar').innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="flex: 1; background: #e0e6ed; border-radius: 10px; height: 24px; overflow: hidden;">
                        <div style="width: ${runwayPercent}%; background: ${barColor}; height: 100%; border-radius: 10px; transition: width 0.5s;"></div>
                    </div>
                    <span style="font-weight: 600; min-width: 100px;">${runway} / 14 months</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #7f8c8d;">
                    <span>Nov-25</span>
                    <span style="color: ${runway < 6 ? '#e4002b' : '#7f8c8d'};">${runway < 6 ? '‚ö†Ô∏è Critical: Start fundraising now' : runway < 9 ? '‚ö° Warning: Plan fundraising' : '‚úÖ Healthy runway'}</span>
                    <span>Dec-26</span>
                </div>
            `;

            // Render cash chart
            renderCashChart();

            // Milestones
            const milestones = [];
            
            // Runway warnings
            if (runway < 6) {
                milestones.push(`<div class="milestone" style="background: linear-gradient(135deg, #e4002b15 0%, #e4002b25 100%); border-left-color: #e4002b;">
                    <h4>üö® Critical: ${runway} months runway</h4>
                    <p style="margin-top: 5px; font-size: 14px;">Cash runs low by ${cashOutDate}. Immediate fundraising recommended.</p>
                </div>`);
            } else if (runway < 9) {
                milestones.push(`<div class="milestone" style="background: linear-gradient(135deg, #f39c1215 0%, #f39c1225 100%); border-left-color: #f39c12;">
                    <h4>‚ö° Warning: ${runway} months runway</h4>
                    <p style="margin-top: 5px; font-size: 14px;">Begin fundraising preparations. Target close before ${cashOutDate}.</p>
                </div>`);
            }
            
            // Funding milestone
            if (data.fundingMonth >= 0 && data.fundingAmount > 0) {
                milestones.push(`<div class="milestone" style="background: linear-gradient(135deg, #27ae6015 0%, #27ae6025 100%); border-left-color: #27ae60;">
                    <h4>üíµ Funding Expected: ${data.months[data.fundingMonth]}</h4>
                    <p style="margin-top: 5px; font-size: 14px;">$${data.fundingAmount.toLocaleString()} raise planned</p>
                </div>`);
            }
            
            if (breakEven !== 'Not reached') {
                milestones.push(`<div class="milestone"><h4>üí∞ Break-Even: ${breakEven}</h4></div>`);
            }
            
            const idx1000 = data.users.findIndex(u => u >= 1000);
            if (idx1000 >= 0) {
                milestones.push(`<div class="milestone"><h4>üë• 1,000 Users: ${data.months[idx1000]}</h4></div>`);
            }
            
            if (annualRev >= 1000000) {
                milestones.push(`<div class="milestone"><h4>üìà $1M Annual Revenue Achieved</h4></div>`);
            }
            
            document.getElementById('milestones').innerHTML = milestones.join('') || '<p>No major milestones reached in forecast period</p>';

            renderGrowthChart();
        }

        function updatePL() {
            const fmt = n => {
                const formatted = '$' + Math.abs(n).toLocaleString(undefined, { maximumFractionDigits: 0 });
                return n < 0 ? '(' + formatted + ')' : formatted;
            };
            
            const fmtClass = n => n < 0 ? 'negative-value' : '';

            let html = '<thead><tr style="background:#f8f9fa;"><th style="color:#53565a;min-width:200px;">Line Item</th>';
            data.months.forEach(m => html += `<th style="color:#53565a;">${m}</th>`);
            html += '</tr></thead><tbody>';

            // USERS SECTION
            html += '<tr class="section-header"><td colspan="' + (data.months.length + 1) + '">üë• USERS</td></tr>';
            
            html += '<tr><td class="indent">Retained Users</td>';
            detailedData.retainedUsers.forEach(u => html += `<td>${u.toLocaleString()}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">New Users</td>';
            detailedData.newUsers.forEach(u => html += `<td>${u.toLocaleString()}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">CAC</td>';
            detailedData.cac.forEach(c => html += `<td>$${c.toFixed(2)}</td>`);
            html += '</tr>';
            
            html += '<tr class="subtotal-row"><td>Total Active Users</td>';
            data.users.forEach(u => html += `<td>${u.toLocaleString()}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">MRPU</td>';
            detailedData.mrpu.forEach(m => html += `<td>$${m.toFixed(2)}</td>`);
            html += '</tr>';

            // REVENUE SECTION
            html += '<tr class="section-header"><td colspan="' + (data.months.length + 1) + '">üí∞ REVENUE</td></tr>';
            
            html += '<tr><td class="indent">Sportsbook GGR</td>';
            detailedData.sbGGR.forEach(g => html += `<td>${fmt(g)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Casino GGR</td>';
            detailedData.casinoGGR.forEach(g => html += `<td>${fmt(g)}</td>`);
            html += '</tr>';
            
            html += '<tr class="subtotal-row"><td>Total GGR</td>';
            data.ggr.forEach(g => html += `<td>${fmt(g)}</td>`);
            html += '</tr>';

            // VARIABLE COSTS SECTION
            html += '<tr class="section-header"><td colspan="' + (data.months.length + 1) + '">üìâ VARIABLE COSTS</td></tr>';
            
            html += '<tr class="subsection-header"><td>Bonus & Promotions</td>';
            detailedData.bonusCosts.forEach(c => html += `<td class="${fmtClass(-c)}">${fmt(-c)}</td>`);
            html += '</tr>';
            
            html += '<tr class="subsection-header"><td>Provider Fees</td><td colspan="' + data.months.length + '"></td></tr>';
            
            html += '<tr><td class="indent">Betby (Sportsbook)</td>';
            detailedData.betbyFee.forEach(f => html += `<td class="${fmtClass(-f)}">${fmt(-f)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Casino Provider</td>';
            detailedData.casinoProvFee.forEach(f => html += `<td class="${fmtClass(-f)}">${fmt(-f)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Flexsy Platform</td>';
            detailedData.flexsyFee.forEach(f => html += `<td class="${fmtClass(-f)}">${fmt(-f)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Gamingtec</td>';
            detailedData.gamingtecFee.forEach(f => html += `<td class="${fmtClass(-f)}">${fmt(-f)}</td>`);
            html += '</tr>';
            
            html += '<tr class="subtotal-row"><td>Total Provider Fees</td>';
            detailedData.totalProvFees.forEach(f => html += `<td class="${fmtClass(-f)}">${fmt(-f)}</td>`);
            html += '</tr>';
            
            html += '<tr class="subsection-header"><td>Payment Processing</td><td colspan="' + data.months.length + '"></td></tr>';
            
            html += '<tr><td class="indent">Deposits Volume</td>';
            detailedData.deposits.forEach(d => html += `<td>${fmt(d)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Transaction Volume</td>';
            detailedData.txnVol.forEach(t => html += `<td>${fmt(t)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Payment Fees</td>';
            detailedData.paymentFee.forEach(f => html += `<td class="${fmtClass(-f)}">${fmt(-f)}</td>`);
            html += '</tr>';

            // GROSS PROFIT
            html += '<tr class="total-row"><td>GROSS PROFIT</td>';
            detailedData.grossProfit.forEach(g => html += `<td class="${fmtClass(g)}">${fmt(g)}</td>`);
            html += '</tr>';

            // FIXED COSTS SECTION
            html += '<tr class="section-header"><td colspan="' + (data.months.length + 1) + '">üè¢ FIXED COSTS</td></tr>';
            
            html += '<tr><td class="indent">Payroll</td>';
            detailedData.payroll.forEach(p => html += `<td class="${fmtClass(-p)}">${fmt(-p)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">G&A</td>';
            detailedData.gna.forEach(g => html += `<td class="${fmtClass(-g)}">${fmt(-g)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Tech Services</td>';
            detailedData.tech.forEach(t => html += `<td class="${fmtClass(-t)}">${fmt(-t)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">KYC</td>';
            detailedData.kyc.forEach(k => html += `<td class="${fmtClass(-k)}">${fmt(-k)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Affiliate Platform</td>';
            detailedData.affPlat.forEach(a => html += `<td class="${fmtClass(-a)}">${fmt(-a)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Affiliate Employee</td>';
            detailedData.affEmp.forEach(a => html += `<td class="${fmtClass(-a)}">${fmt(-a)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">CS Center</td>';
            detailedData.csTotal.forEach(c => html += `<td class="${fmtClass(-c)}">${fmt(-c)}</td>`);
            html += '</tr>';
            
            html += '<tr><td class="indent">Marketing</td>';
            detailedData.marketing.forEach(m => html += `<td class="${fmtClass(-m)}">${fmt(-m)}</td>`);
            html += '</tr>';
            
            html += '<tr class="subtotal-row"><td>Total Fixed Costs</td>';
            detailedData.totalFixedCosts.forEach(f => html += `<td class="${fmtClass(-f)}">${fmt(-f)}</td>`);
            html += '</tr>';

            // ONE-TIME COSTS
            html += '<tr><td>One-Time Costs</td>';
            detailedData.oneTimeCosts.forEach(o => html += `<td class="${fmtClass(-o)}">${fmt(-o)}</td>`);
            html += '</tr>';

            // EBITDA
            html += '<tr class="total-row"><td>EBITDA</td>';
            data.ebitda.forEach(e => html += `<td class="${fmtClass(e)}">${fmt(e)}</td>`);
            html += '</tr>';

            // CUMULATIVE CASH
            html += '<tr class="total-row"><td>Cumulative Cash Flow</td>';
            detailedData.cumCash.forEach(c => html += `<td class="${fmtClass(c)}">${fmt(c)}</td>`);
            html += '</tr>';

            // FUNDING SECTION
            html += '<tr class="section-header"><td colspan="' + (data.months.length + 1) + '">üíµ CASH POSITION</td></tr>';
            
            html += '<tr><td>Starting Cash</td>';
            data.months.forEach((m, i) => html += `<td>${i === 0 ? fmt(data.startingCash) : '-'}</td>`);
            html += '</tr>';
            
            html += '<tr><td>Funding Inflow</td>';
            detailedData.fundingInflow.forEach(f => html += `<td>${f > 0 ? fmt(f) : '-'}</td>`);
            html += '</tr>';
            
            html += '<tr class="total-row"><td>Cash Balance</td>';
            detailedData.cashBalance.forEach(c => html += `<td class="${fmtClass(c)}">${fmt(c)}</td>`);
            html += '</tr>';

            html += '</tbody>';
            document.getElementById('plTable').innerHTML = html;
        }

        function renderCashChart() {
            const ctx = document.getElementById('cashChart');
            if (charts.cash) charts.cash.destroy();
            
            // Create zone backgrounds
            const bufferLine = Array(14).fill(data.cashBuffer);
            const warningLine = Array(14).fill(data.cashBuffer * 3);
            
            charts.cash = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Cash Balance',
                        data: detailedData.cashBalance,
                        borderColor: '#53565a',
                        backgroundColor: 'rgba(83,86,90,0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: detailedData.cashBalance.map(c => {
                            if (c <= data.cashBuffer) return '#e4002b';
                            if (c <= data.cashBuffer * 3) return '#f39c12';
                            return '#27ae60';
                        }),
                        pointRadius: 5
                    }, {
                        label: 'Minimum Buffer',
                        data: bufferLine,
                        borderColor: '#e4002b',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'Monthly EBITDA',
                        data: data.ebitda,
                        type: 'bar',
                        backgroundColor: data.ebitda.map(e => e >= 0 ? 'rgba(39,174,96,0.6)' : 'rgba(228,0,43,0.6)'),
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const idx = context[0].dataIndex;
                                    const funding = detailedData.fundingInflow[idx];
                                    if (funding > 0) {
                                        return `\nüíµ Funding: +$${funding.toLocaleString()}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Cash Balance ($)' },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) return '#e4002b';
                                    return 'rgba(0,0,0,0.1)';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Monthly EBITDA ($)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function renderGrowthChart() {
            const ctx = document.getElementById('growthChart');
            if (charts.growth) charts.growth.destroy();
            
            charts.growth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Users',
                        data: data.users,
                        borderColor: '#e4002b',
                        backgroundColor: 'rgba(228,0,43,0.1)',
                        yAxisID: 'y',
                        tension: 0.3
                    }, {
                        label: 'Gross Profit',
                        data: detailedData.grossProfit,
                        borderColor: '#53565a',
                        backgroundColor: 'rgba(83,86,90,0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Users' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Gross Profit ($)' }
                        }
                    }
                }
            });
        }

        function renderCharts() {
            // Revenue & Users Chart
            const ctx1 = document.getElementById('revChart');
            if (charts.rev) charts.rev.destroy();
            
            charts.rev = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Total Users',
                        data: data.users,
                        borderColor: '#e4002b',
                        backgroundColor: 'rgba(228,0,43,0.1)',
                        yAxisID: 'y',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'GGR',
                        data: data.ggr,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39,174,96,0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }, {
                        label: 'Gross Profit',
                        data: detailedData.grossProfit,
                        borderColor: '#53565a',
                        backgroundColor: 'rgba(83,86,90,0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Users' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Revenue ($)' }
                        }
                    }
                }
            });

            // EBITDA & Cash Flow Chart
            const ctx2 = document.getElementById('profitChart');
            if (charts.profit) charts.profit.destroy();
            
            charts.profit = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Monthly EBITDA',
                        data: data.ebitda,
                        backgroundColor: data.ebitda.map(e => e >= 0 ? '#27ae60' : '#e4002b'),
                        yAxisID: 'y'
                    }, {
                        label: 'Cumulative Cash Flow',
                        data: detailedData.cumCash,
                        type: 'line',
                        borderColor: '#53565a',
                        backgroundColor: 'rgba(83,86,90,0.1)',
                        yAxisID: 'y',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Amount ($)' }
                        }
                    }
                }
            });

            // User Growth Chart
            const ctx3 = document.getElementById('userChart');
            if (charts.user) charts.user.destroy();
            
            charts.user = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Retained Users',
                        data: detailedData.retainedUsers,
                        backgroundColor: '#e4002b',
                        stack: 'stack0'
                    }, {
                        label: 'New Users',
                        data: detailedData.newUsers,
                        backgroundColor: '#53565a',
                        stack: 'stack0'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { display: true, text: 'Users' }
                        }
                    }
                }
            });
        }

        // Initialize
        calc();
    </script>
</body>
</html>
